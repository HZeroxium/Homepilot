<!-- views/dashboard.ejs -->
<% title = 'Dashboard' %>

<!-- Thêm script để lấy FCM Token -->
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-messaging.js"></script>

<script>
  // Cấu hình Firebase
  const firebaseConfig = {
    apiKey: process.env.FIREBASE_API_KEY,
    authDomain: process.env.FIREBASE_AUTH_DOMAIN,
    projectId: process.env.FIREBASE_PROJECT_ID,
    storageBucket: process.env.FIREBASE_STORAGE_BUCKET,
    messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID,
    appId: process.env.FIREBASE_APP_ID,
    measurementId: process.env.FIREBASE_MEASUREMENT_ID,
  }
  
  firebase.initializeApp(firebaseConfig);
  const messaging = firebase.messaging();

  // Yêu cầu quyền nhận thông báo
  messaging
    .requestPermission()
    .then(() => {
      console.log('Notification permission granted.');
      return messaging.getToken();
    })
    .then((token) => {
      console.log('FCM Token:', token);
      // Gửi token về server
      fetch('/save-fcm-token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ fcmToken: token }),
      });
    })
    .catch((err) => {
      console.error('Unable to get permission to notify.', err);
    });
</script>

<main class="container mx-auto px-4">
  <h2 class="text-2xl font-bold text-primary mb-4">Dashboard</h2>
  <p>Xin chào, <%= user.displayName %>!</p>

  <% if (error_msg) { %>
    <div class="alert alert-error"><%= error_msg %></div>
  <% } %>
  <% if (success_msg) { %>
    <div class="alert alert-success"><%= success_msg %></div>
  <% } %>

  <h3 class="text-xl font-semibold mt-6 mb-10">Thiết bị của bạn:</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <% devices.forEach(device => { %>
      <div class="card">
        <h4 class="card-title"><%= device.name %></h4>
        <p>Loại: <%= device.type %></p>
        <p class="device-status">Trạng thái: <%= device.status %></p>
        <a href="/devices/<%= device.type %>" class="btn btn-primary mt-2 inline-block">Quản lý</a>
        <div class="mt-2 flex space-x-2">
          <a href="/devices/<%= device.uid %>/edit" class="btn btn-secondary inline-block">Chỉnh Sửa</a>
          <form action="/devices/<%= device.uid %>/delete" method="POST" onsubmit="return confirm('Bạn có chắc chắn muốn xóa thiết bị này?');">
            <button type="submit" class="btn btn-danger">Xóa</button>
          </form>
        </div>
      </div>
    <% }) %>
  </div>

  <a href="/devices/add" class="btn btn-secondary mt-6">Thêm Thiết Bị Mới</a>
</main>



<!-- Nhúng tệp JavaScript -->
<script src="/socket.io/socket.io.js"></script>
<script src="/js/main.js"></script>
